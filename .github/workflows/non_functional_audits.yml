name: Non-Functional Testing Pipeline
on: [push, pull_request]

jobs:
  # SECURITY 
  security_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test

 # PERFORMANCE & SPEED TESTING
  speed_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' 

      - name: Install Lighthouse ONLY
        run: |
          npm install lighthouse 
          npm install puppeteer-core 

      - name: Run Audit Script
        env:
          EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          PASSWORD: ${{ secrets.TEST_USER_PASS }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome 
        run: |
          cat << 'EOF' > lighthouse-auth.js
          const puppeteer = require('puppeteer-core');
          const { execSync } = require('child_process');

          (async () => {
            const browser = await puppeteer.launch({
              executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
              headless: "new",
              args: ['--no-sandbox']
            });
            const page = await browser.newPage();
            
            await page.goto('https://gradversion3.netlify.app/');
            await page.waitForSelector('input[type="email"]');
            await page.type('input[type="email"]', process.env.EMAIL);
            await page.type('input[type="password"]', process.env.PASSWORD);
            await page.click('.login-button');

            // Wait for sidebar to confirm login
            await page.waitForSelector('.dashboard-sidebar', { timeout: 10000 });

            const port = new URL(browser.wsEndpoint()).port;
            // Run Lighthouse on ONLY the necessary categories to save time
            execSync(`npx lighthouse https://gradversion3.netlify.app/ --port=${port} --output html --output-path ./lh-report.html --only-categories=performance,accessibility --chrome-flags="--headless"`);
            
            await browser.close();
          })();
          EOF
          node lighthouse-auth.js

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lh-report.html

  # LOAD TESTING
  load_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run JMeter Test
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: raqeeb_test_plan.jmx
          command: "-n -t raqeeb_test_plan.jmx -l results.jtl -Jduration=30 -X"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results.jtl./reports/
