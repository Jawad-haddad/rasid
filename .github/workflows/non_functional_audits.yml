name: Non-Functional Testing Pipeline
on: [push, pull_request]

jobs:
  # SECURITY 
  security_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test

  # PERFORMANCE & SPEED TESTING
  speed_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' 

      - name: Install Lighthouse and Puppeteer
        run: |
          npm install lighthouse puppeteer-core

      - name: Run Audit Script
        env:
          EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          PASSWORD: ${{ secrets.TEST_USER_PASS }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome 
        run: |
          cat << 'EOF' > lighthouse-auth.js
          const puppeteer = require('puppeteer-core');
          const { startFlow } = require('lighthouse');
          const fs = require('fs');

          (async () => {
            const browser = await puppeteer.launch({
              executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
              headless: "new",
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
         
            const flow = await startFlow(page, {
              name: 'Raqeeb Authenticated Dashboard Audit',
              configContext: { settings: { screenEmulation: { disabled: true } } }
            });

            console.log('Step 1: Navigating to Login...');
            await page.goto('https://gradversion3.netlify.app/');
            await page.waitForSelector('input[type="email"]');
            await page.type('input[type="email"]', process.env.EMAIL);
            await page.type('input[type="password"]', process.env.PASSWORD);
            
            console.log('Step 2: Submitting Credentials...');
            await page.click('.login-button');
            
            await page.waitForSelector('.dashboard-sidebar', { timeout: 15000 });
            console.log('Step 3: Dashboard detected! Capturing Snapshot...');

            await flow.snapshot();

            // 4. Generate and save the report
            const report = await flow.generateReport();
            fs.writeFileSync('lh-report.html', report);
            
            console.log('Step 4: Report generated successfully.');
            await browser.close();
          })();
          EOF
          node lighthouse-auth.js

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lh-report.html

  # LOAD TESTING
  load_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run JMeter Load Test
        uses: QAInsights/PerfAction@v5.6.2
        with:
          test-plan-path: './raqeeb_test_plan.jmx' 
          args: "-e -o ./reports/ -Jduration=30 -X"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: results.jtl./reports/
