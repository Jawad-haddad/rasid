name: Non-Functional Testing Pipeline
on: [push, pull_request]

jobs:
  # SECURITY TESTING: Checks for vulnerabilities 
  security_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test

  # PERFORMANCE TESTING: Checks website speed and best practices
  speed_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer and Lighthouse
        run: npm install puppeteer lighthouse

      - name: Create Lighthouse Auth Script
        run: |
          cat << 'EOF' > lighthouse-auth.js
          const puppeteer = require('puppeteer');
          const { execSync } = require('child_process');

          (async () => {
            const browser = await puppeteer.launch({
              headless: "new",
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            console.log('Logging in to gradversion3.netlify.app...');
            await page.goto('https://gradversion3.netlify.app/login', { waitUntil: 'networkidle2' });

            await page.type('#email', '${{ secrets.TEST_USER_EMAIL }}');
            await page.type('#password', '${{ secrets.TEST_USER_PASS }}');
            
            await Promise.all([
              page.click('#login-button'), 
              page.waitForNavigation({ waitUntil: 'networkidle0' }),
            ]);

            console.log('Login successful. Running Lighthouse on Dashboard...');
            const port = new URL(browser.wsEndpoint()).port;
            
            execSync(npx lighthouse https://gradversion3.netlify.app/dashboard --port=${port} --output html --output-path ./lh-report.html --chrome-flags="--headless");

            await browser.close();
            console.log('Audit complete.');
          })();
          EOF

      - name: Run Authenticated Lighthouse Audit
        run: node lighthouse-auth.js

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-dashboard-report
          path: lh-report.html

  #  LOAD TESTING: Checks stability for 100 users
  load_audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run JMeter Load Test
        uses: QAInsights/PerfAction@v5.6.2
        with:
          test-plan-path: './raqeeb_test_plan.jmx' 
          args: "-e -o ./reports/"
      - name: Upload JMeter Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: ./reports/
